<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CreativeScore AI - Analizzatore CRO & Comportamentale</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
      
      * { box-sizing: border-box; }
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0f172a;
        color: #f8fafc;
        min-height: 100vh;
        margin: 0;
      }
      
      .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .animate-fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      }
      
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideInRight {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      .animate-slide-in {
        animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }
      
      @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.6); }
      }
      
      .pulse-glow {
        animation: pulse-glow 2s ease-in-out infinite;
      }
      
      @keyframes progress {
        0% { width: 0%; }
        20% { width: 15%; }
        40% { width: 35%; }
        60% { width: 55%; }
        80% { width: 78%; }
        95% { width: 92%; }
        100% { width: 100%; }
      }
      
      .progress-bar {
        animation: progress 4s ease-in-out;
        animation-fill-mode: forwards;
      }
      
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      
      .shimmer {
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
        background-size: 200% 100%;
        animation: shimmer 1.5s ease-in-out infinite;
      }
      
      .drop-zone-active {
        border-color: #818cf8 !important;
        background: rgba(99, 102, 241, 0.15) !important;
      }
      
      /* Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      /* Nav sidebar */
      .nav-sidebar {
        position: fixed;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 40;
      }
      
      .nav-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #334155;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
      }
      
      .nav-dot:hover, .nav-dot.active {
        background: #818cf8;
        transform: scale(1.4);
      }
      
      .nav-dot .tooltip {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        white-space: nowrap;
        background: #1e293b;
        border: 1px solid rgba(255,255,255,0.1);
        color: #e2e8f0;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      
      .nav-dot:hover .tooltip {
        opacity: 1;
      }
      
      /* Toast */
      .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        z-index: 100;
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }
      
      .toast.show {
        transform: translateX(-50%) translateY(0);
      }
      
      /* Print */
      @media print {
        header, .upload-section, .download-buttons, .nav-sidebar, .toast { display: none !important; }
        body { background-color: white; color: black; }
        .glass-panel { background: white !important; border: 1px solid #e2e8f0; color: black; }
        #root { padding: 0 !important; margin: 0 !important; }
        main { margin-top: 0 !important; }
        .text-white, .text-slate-200, .text-slate-300 { color: black !important; }
        .text-slate-400, .text-slate-500 { color: #64748b !important; }
        .bg-slate-900, .bg-slate-800, .bg-slate-950 { background-color: #f8fafc !important; }
      }
      
      /* Focus states for accessibility */
      button:focus-visible, a:focus-visible, input:focus-visible {
        outline: 2px solid #818cf8;
        outline-offset: 2px;
      }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "lucide-react": "https://esm.sh/lucide-react@0.460.0?external=react"
      }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useCallback, useRef, useEffect, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Upload, ScanEye, Sparkles, AlertCircle, Loader2, ArrowRight,
        CheckCircle2, AlertTriangle, Lightbulb, Brain, Activity, MessageSquareQuote, 
        Zap, Search, ArrowRightCircle, Download, FileText, Image as ImageIcon, 
        FileDown, ShieldCheck, Target, Lock, MousePointer2, Layout, Users,
        TrendingUp, Layers, Repeat, List, RotateCcw, ChevronUp, Settings,
        Eye, X, Menu
      } from 'lucide-react';

      // --- TYPES & CONSTANTS ---
      const AnalysisStatus = { IDLE: 'IDLE', ANALYZING: 'ANALYZING', COMPLETE: 'COMPLETE', ERROR: 'ERROR' };

      const SYSTEM_INSTRUCTION = `
Sei un esperto di livello mondiale in Ottimizzazione del Tasso di Conversione (CRO), Neuro-Marketing e Scienze Comportamentali.
Il tuo compito è analizzare screenshot di landing page fornendo un report strutturato e professionale di 45 punti.
RISPONDI ESCLUSIVAMENTE IN ITALIANO. Sii estremamente critico.
`;

      // --- MOCK DATA ---
      const getMockAnalysis = async () => {
        await new Promise(r => setTimeout(r, 3500));
        return {
          heatmap: [
            { x: 50, y: 20, intensity: 0.9 },
            { x: 20, y: 45, intensity: 0.6 },
            { x: 80, y: 45, intensity: 0.7 },
            { x: 50, y: 75, intensity: 0.8 },
            { x: 30, y: 30, intensity: 0.5 },
          ],
          report: {
            executiveSummary: {
              judgment: "La pagina comunica chiaramente l'offerta ma fallisce nel creare un senso di urgenza e nel differenziarsi dai competitor, risultando troppo generica per convertire utenti alto-spendenti.",
              topProblems: [
                "Mancanza di una Unique Value Proposition (UVP) chiara e specifica.",
                "Eccessivo attrito nel form di contatto principale (troppi campi).",
                "Assenza di prove sociali numeriche e case study dettagliati."
              ],
              topActions: [
                "Riscrivere la headline focalizzandola su un beneficio economico misurabile.",
                "Semplificare il form di contatto riducendolo a 3-4 campi essenziali.",
                "Inserire una sezione di testimonianze con dati ROI reali subito dopo il fold."
              ]
            },
            categories: [
              {
                title: "Attenzione e Prima Impressione",
                points: [
                  { id: 1, name: "Gerarchia visiva e attenzione", score: 65, problems: "L'occhio cade sul logo invece che sulla headline principale.", actions: "Aumentare il peso visivo della Headline e usare il contrasto per guidare verso la CTA." },
                  { id: 2, name: "Chiarezza strutturale e navigazione", score: 70, problems: "Menu troppo affollato che distrae dall'obiettivo unico.", actions: "Rimuovere i link secondari dal menu header per focalizzare sul pulsante di conversione." },
                  { id: 3, name: "Esperienza d'uso e mobile", score: 55, problems: "Pulsanti troppo piccoli da cliccare su smartphone e tempi di caricamento sopra i 3s.", actions: "Ottimizzare le immagini e aumentare la dimensione delle aree cliccabili (min 44px)." },
                  { id: 4, name: "Impatto above the fold", score: 45, problems: "Beneficio principale non visibile senza scrollare.", actions: "Spostare la promessa di valore più in alto, assicurandosi che sia leggibile istantaneamente." }
                ]
              },
              {
                title: "Messaggio e Promessa",
                points: [
                  { id: 5, name: "Forza della headline", score: 50, problems: "Troppo descrittiva ('cosa facciamo') e poco orientata al risultato ('cosa ottieni').", actions: "Riscrivere usando la formula: [Risultato] + [Tempo] + [Senza dolore/costo]." },
                  { id: 6, name: "Concretezza dei benefici", score: 40, problems: "Uso di aggettivi vaghi come 'migliore', 'veloce', 'innovativo'.", actions: "Sostituire aggettivi con numeri (es. 'Riduzione costi del 20%')." },
                  { id: 7, name: "Differenziazione dai competitor", score: 30, problems: "La soluzione sembra identica ad altre 10 presenti sul mercato.", actions: "Individuare un 'Meccanismo Unico' (es. un algoritmo proprietario) e dargli un nome." },
                  { id: 8, name: "Valore unico immediato", score: 45, problems: "Bisogna leggere tutta la pagina per capire perché dovrei scegliervi.", actions: "Inserire 3 bullet point di 'perché noi' subito sotto la headline." },
                  { id: 9, name: "Coerenza promessa emotiva/prova razionale", score: 55, problems: "Promesse grandi non supportate da fatti tecnici credibili.", actions: "Aggiungere un grafico o una spiegazione 'Sotto il cofano' che spieghi il funzionamento." }
                ]
              },
              {
                title: "Persuasione e Fiducia",
                points: [
                  { id: 10, name: "Leve psicologiche di persuasione", score: 40, problems: "Assenza totale di scarsità e scarsa autorità percepita.", actions: "Aggiungere loghi di stampa o certificazioni e un timer/limite di posti." },
                  { id: 11, name: "Prove sociali e risultati numerici", score: 35, problems: "Testimonianze vaghe tipo 'Ottimo servizio, consigliato'.", actions: "Chiedere citazioni che parlino di numeri specifici (es. 'Fatturato +15%')." },
                  { id: 12, name: "Supporto visivo alle promesse", score: 60, problems: "Immagini stock che non mostrano il prodotto o il risultato reale.", actions: "Usare screenshot reali o foto di clienti reali durante l'uso del servizio." },
                  { id: 13, name: "Gestione delle obiezioni", score: 25, problems: "Ignora i dubbi tipici dell'utente (costo, tempo, complessità).", actions: "Inserire una sezione FAQ o 'Cosa dicono gli scettici' per smontare i dubbi." },
                  { id: 14, name: "Riduzione del rischio percepito", score: 50, problems: "Manca una garanzia chiara di soddisfazione o rimborso.", actions: "Aggiungere badge 'Soddisfatti o Rimborsati' o 'Prova gratuita 14 giorni'." },
                  { id: 15, name: "Gestione dell'ansia da contatto umano", score: 45, problems: "L'utente teme di essere richiamato da un venditore aggressivo.", actions: "Specificare: 'Consulenza gratuita, nessun impegno di acquisto'." },
                  { id: 16, name: "Prova di attualità e freschezza", score: 30, problems: "Copyright fermo al 2022 e recensioni datate.", actions: "Aggiornare le date e mostrare risultati ottenuti nell'ultimo mese." }
                ]
              },
              {
                title: "Azione e Frizione",
                points: [
                  { id: 17, name: "Efficacia delle CTA", score: 60, problems: "Testo generico ('Invia', 'Scopri di più').", actions: "Usare verbi d'azione orientati al beneficio (es. 'Inizia a Risparmiare Ora')." },
                  { id: 18, name: "Coerenza microcopy–titoli–bottoni", score: 55, problems: "Incongruenza tra ciò che promette il titolo e ciò che fa il bottone.", actions: "Assicurarsi che il bottone sia la naturale risposta alla domanda posta nel titolo." },
                  { id: 19, name: "Attrito del form", score: 35, problems: "Richiede 8 campi inclusi telefono e indirizzo fisico.", actions: "Ridurre a 3 campi: Nome, Email, URL Sito (per analisi)." },
                  { id: 20, name: "Percezione semplicità primo passo", score: 50, problems: "Sembra che l'impegno richiesto sia troppo grande da subito.", actions: "Promuovere un 'Check-up gratuito di 5 minuti' come primo step." },
                  { id: 21, name: "Rapporto sforzo/valore percepito", score: 45, problems: "L'utente deve fare troppa fatica per capire cosa riceverà in cambio.", actions: "Visualizzare il 'Regalo' o il 'Risultato' finale accanto al form." },
                  { id: 22, name: "Gradualità della richiesta di impegno", score: 40, problems: "Passa dal nulla all'acquisto/contatto pesante senza step medi.", actions: "Offrire un lead magnet (PDF/Video) prima della proposta di vendita." }
                ]
              },
              {
                title: "Percorso Decisionale",
                points: [
                  { id: 23, name: "Flusso persuasivo delle sezioni", score: 50, problems: "Logica saltellante: parla della soluzione prima di aver spiegato il problema.", actions: "Seguire lo schema: Problema -> Agitazione -> Soluzione -> Prova -> Azione." },
                  { id: 24, name: "Gestione micro-decisioni allo scroll", score: 45, problems: "Ogni scroll non risolve un dubbio, ma ne crea di nuovi.", actions: "Ogni sezione deve chiudere un'obiezione e spingere a continuare la lettura." },
                  { id: 25, name: "Ridondanza strategica messaggi chiave", score: 60, problems: "Il valore principale viene detto una volta sola e poi dimenticato.", actions: "Ripetere il beneficio principale almeno 3 volte in modi diversi." },
                  { id: 26, name: "Chiusura forte e memorabile", score: 30, problems: "La pagina finisce nel nulla o con un footer triste.", actions: "Inserire una 'Last Chance Offer' o un riassunto dei benefici finale." }
                ]
              },
              {
                title: "Chiarezza dell'Offerta",
                points: [
                  { id: 27, name: "Chiarezza dell'offerta concreta", score: 65, problems: "Non è chiaro cosa ricevo esattamente dopo il pagamento/contatto.", actions: "Inserire una lista puntata: 'Cosa include il pacchetto'." },
                  { id: 28, name: "Trasparenza su tempi e percorso", score: 40, problems: "Non so quanto tempo ci vorrà per vedere i risultati.", actions: "Creare una timeline 1-2-3 che mostri le tappe del servizio." },
                  { id: 29, name: "Chiarezza del dopo-conversione", score: 35, problems: "Dopo aver cliccato, non so se riceverò una mail o una chiamata.", actions: "Specificare sotto il bottone: 'Riceverai una conferma via email entro 10 minuti'." }
                ]
              },
              {
                title: "Target e Coerenza del Messaggio",
                points: [
                  { id: 30, name: "Rilevanza per il target", score: 55, problems: "Parla a 'tutte le aziende', rischiando di non parlare a nessuno.", actions: "Specificare la nicchia (es. 'Per E-commerce di abbigliamento')." },
                  { id: 31, name: "Chiarezza del cliente ideale", score: 45, problems: "Non dice per chi NON è adatto il servizio.", actions: "Aggiungere una sezione 'Siamo perfetti per te se...' e 'Non siamo adatti se...'." },
                  { id: 32, name: "Coerenza tono di voce e target", score: 70, problems: "Tono troppo formale per un target di giovani creativi.", actions: "Usare un linguaggio più diretto, attivo e meno burocratico." },
                  { id: 33, name: "Match con l'intento dell'utente", score: 60, problems: "L'utente cerca una soluzione rapida ma la pagina è prolissa.", actions: "Accorciare i testi e usare più grassetti per facilitare la scansione." },
                  { id: 34, name: "Continuità con il canale di provenienza", score: 50, problems: "Promessa dell'annuncio Facebook non mantenuta sulla Landing.", actions: "Assicurarsi che le prime 5 parole della pagina siano le stesse dell'annuncio." }
                ]
              },
              {
                title: "Focus sulla Conversione",
                points: [
                  { id: 35, name: "Controllo delle distrazioni", score: 75, problems: "Presenza di icone social che portano l'utente fuori dalla pagina.", actions: "Rimuovere tutti i link esterni che non siano la CTA principale." },
                  { id: 36, name: "Costo del non agire (loss aversion)", score: 40, problems: "L'utente non sente il dolore di restare come è adesso.", actions: "Spiegare quanti soldi/tempo sta perdendo ogni giorno senza questa soluzione." },
                  { id: 37, name: "Urgenza e scarsità", score: 20, problems: "Nessun motivo per agire oggi invece che tra un mese.", actions: "Limitare l'offerta ai prossimi 7 giorni o ai primi 5 clienti." }
                ]
              },
              {
                title: "Struttura e Profondità",
                points: [
                  { id: 38, name: "Leggibilità e scansionabilità", score: 80, problems: "Muri di testo troppo lunghi.", actions: "Spezzare i paragrafi ogni 2-3 righe e usare liste puntate." },
                  { id: 39, name: "Coerenza promessa -> contenuto -> CTA", score: 65, problems: "Si parla di 'Velocità' ma il contenuto parla di 'Sicurezza'.", actions: "Rileggere la pagina assicurandosi che ogni sezione supporti la Headline." },
                  { id: 40, name: "Lunghezza vs Complessità", score: 60, problems: "Pagina troppo corta per un servizio da 5.000€.", actions: "Aggiungere dettagli tecnici e prove per giustificare l'alto valore." }
                ]
              }
            ],
            behavioral: [
              { name: "Social Proof", status: "parziale", observation: "Presenti alcune citazioni ma mancano loghi di aziende note.", improvement: "Aggiungere loghi 'Trusted by' e numeri reali di utenti." },
              { name: "Scarcity", status: "mancante", observation: "Nessun elemento di urgenza temporale.", improvement: "Inserire un'offerta a tempo limitato o contatore posti." },
              { name: "Authority", status: "applicato", observation: "L'autorevolezza è ben comunicata tramite le certificazioni.", improvement: "" },
              { name: "Loss Aversion", status: "mancante", observation: "Non viene evidenziato il costo dell'inazione.", improvement: "Aggiungere una sezione 'Quanto ti costa non agire?' con calcolo perdite." },
              { name: "Anchoring", status: "parziale", observation: "Prezzo presente ma senza confronto con alternative.", improvement: "Mostrare il costo dell'alternativa (consulente esterno) vs il vostro servizio." },
              { name: "Reciprocity", status: "mancante", observation: "Nessun valore gratuito offerto prima della richiesta.", improvement: "Offrire un audit gratuito, checklist o mini-corso come lead magnet." },
              { name: "Commitment & Consistency", status: "parziale", observation: "Form diretto senza micro-impegni precedenti.", improvement: "Inserire un quiz o assessment breve prima del form principale." },
              { name: "Framing", status: "parziale", observation: "Benefici presentati in modo neutro.", improvement: "Riformulare in termini di guadagno vs perdita: 'Risparmia 10.000€/anno' vs 'Stai perdendo 10.000€/anno'." },
              { name: "Bandwagon Effect", status: "mancante", observation: "Non viene comunicata la popolarità del servizio.", improvement: "Aggiungere contatori tipo '+500 aziende ci hanno scelto questo mese'." },
              { name: "Cognitive Dissonance", status: "applicato", observation: "La garanzia riduce il conflitto post-decisione.", improvement: "" }
            ],
            nlp: {
              tone: "Professionale",
              readingLevel: "Medio",
              emotionalTriggers: ["Paura di perdere opportunità", "Desiderio di crescita", "Frustrazione per risultati mediocri"],
              principles: [
                { name: "Anchoring (NLP)", status: "applicato", observation: "Prezzo barrato efficace come ancora cognitiva.", improvement: "" },
                { name: "Rapport Building", status: "parziale", observation: "Linguaggio un po' troppo formale e distaccato.", improvement: "Usare più 'Tu' e meno 'Noi'. Rispecchiare il linguaggio del target." },
                { name: "Pacing and Leading", status: "mancante", observation: "Non si parte dal mondo del lettore prima di proporre la soluzione.", improvement: "Iniziare con 'Se sei come la maggior parte dei...' prima di presentare l'offerta." },
                { name: "Reframing", status: "parziale", observation: "Il prezzo non viene riformulato in termini comprensibili.", improvement: "Trasformare '2.400€/anno' in 'meno di 6,50€ al giorno, meno di un caffè'." },
                { name: "Milton Model", status: "mancante", observation: "Assenza di linguaggio ipnotico e presupposizioni.", improvement: "Usare frasi come 'Quando vedrai i primi risultati...' (presuppone il successo)." },
                { name: "Meta Programs", status: "parziale", observation: "Testo orientato solo 'verso' (guadagno) ma non 'via da' (dolore).", improvement: "Bilanciare con frasi 'via da': 'Smetti di perdere clienti ogni giorno'." }
              ]
            },
            optimization: {
              impactScores: [
                { area: "Riprova Sociale", impact: "Alto", boost: "+22%", priority: 1 },
                { area: "Semplificazione Form", impact: "Alto", boost: "+18%", priority: 2 },
                { area: "Headline & UVP", impact: "Alto", boost: "+15%", priority: 3 },
                { area: "Urgenza/Scarsità", impact: "Medio", boost: "+10%", priority: 4 },
                { area: "Velocità Mobile", impact: "Medio", boost: "+8%", priority: 5 }
              ],
              operationalPriorities: {
                singles: [
                  "Riscrivere la headline con focus sul ROI misurabile",
                  "Rimuovere il campo 'Telefono' dal form principale",
                  "Aggiungere 3 video testimonianze con dati reali",
                  "Migliorare il contrasto del bottone CTA (ratio 4.5:1 min)",
                  "Inserire garanzia soddisfatti o rimborsati 30 giorni"
                ],
                combos: [
                  "Headline rinnovata + Social Proof nel fold visibile",
                  "Urgenza (timer) + Rassicurazione Privacy (badge GDPR)",
                  "Micro-impegno (quiz) + Form ridotto (3 campi)"
                ]
              },
              abTestPlan: [
                { test: "Headline A vs B", change: "Benefit-driven vs Process-driven", reason: "Capire se il target risponde più al 'come' o al 'cosa ottieni'.", metric: "Bounce Rate + CTR" },
                { test: "Form Wizard vs Singolo", change: "2 step progressivi vs 1 step unico", reason: "Ridurre il carico cognitivo iniziale e aumentare il commitment.", metric: "Conversion Rate" },
                { test: "Testimonianze Video vs Testo", change: "3 video reali vs Citazioni testuali", reason: "Aumentare il trust percepito e il tempo sulla pagina.", metric: "Trust Score / Time on Page" }
              ],
              strategicGuidelines: {
                toneOfVoice: "Professionale ma empatico, orientato alla risoluzione di problemi concreti. Evitare gergo tecnico non necessario.",
                dominantLevers: ["Autorità", "Riprova Sociale", "Loss Aversion"],
                argumentOrder: "Agitazione Problema -> Meccanismo Unico -> Prova Sociale -> Garanzia -> CTA con urgenza"
              }
            },
            finalSummary: {
              overallScore: 48,
              conclusion: "La pagina ha fondamenta solide ma è 'troppo educata'. Manca di mordente commerciale, non sfida lo status quo del cliente e non offre prove inconfutabili del suo valore. Con le modifiche suggerite (specie su UVP, Form e Social Proof), il potenziale di crescita è stimato al +40% di conversioni."
            }
          }
        };
      };

      // --- API CALL ---
      const analyzeWithGemini = async (base64Image, apiKey) => {
        if (!apiKey) throw new Error("API Key mancante. Configura la tua Gemini API Key nelle impostazioni.");
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { inlineData: { mimeType: "image/png", data: base64Image } },
                { text: "Esegui l'audit completo di 45 punti per questa landing page. Rispondi in JSON valido." }
              ]
            }],
            systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
            generationConfig: {
              temperature: 0.2,
              responseMimeType: "application/json"
            }
          })
        });
        
        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(errData?.error?.message || `Errore API: ${response.status}`);
        }
        
        const data = await response.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("Risposta vuota dall'API.");
        return JSON.parse(text);
      };

      // --- UTILITY COMPONENTS ---

      const Toast = ({ message, type, visible }) => (
        <div className={`toast ${visible ? 'show' : ''}`}>
          <div className={`flex items-center gap-3 px-6 py-3 rounded-xl shadow-2xl border ${
            type === 'success' ? 'bg-emerald-900/90 border-emerald-500/30 text-emerald-200' :
            type === 'error' ? 'bg-red-900/90 border-red-500/30 text-red-200' :
            'bg-slate-800/90 border-slate-600/30 text-slate-200'
          }`}>
            {type === 'success' && <CheckCircle2 size={18} />}
            {type === 'error' && <AlertCircle size={18} />}
            <span className="text-sm font-medium">{message}</span>
          </div>
        </div>
      );

      const ScrollToTop = () => {
        const [visible, setVisible] = useState(false);
        useEffect(() => {
          const toggle = () => setVisible(window.scrollY > 600);
          window.addEventListener('scroll', toggle);
          return () => window.removeEventListener('scroll', toggle);
        }, []);
        if (!visible) return null;
        return (
          <button
            onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
            className="fixed bottom-6 right-6 z-50 w-12 h-12 bg-indigo-600 hover:bg-indigo-500 rounded-full flex items-center justify-center shadow-xl shadow-indigo-500/30 transition-all"
            aria-label="Torna su"
          >
            <ChevronUp size={20} className="text-white" />
          </button>
        );
      };

      const HeatmapOverlay = ({ imageSrc, points }) => (
        <div className="relative w-full overflow-hidden rounded-2xl shadow-2xl group border border-slate-700/50 bg-slate-900">
          <img src={imageSrc} alt="Contenuto analizzato" className="w-full h-auto block object-contain" />
          <div className="absolute inset-0 mix-blend-screen pointer-events-none">
            {points?.map((point, index) => (
              <div key={index} className="absolute rounded-full blur-xl"
                style={{
                  left: `${point.x}%`, top: `${point.y}%`,
                  width: `${100 * point.intensity}px`, height: `${100 * point.intensity}px`,
                  transform: 'translate(-50%, -50%)',
                  background: `radial-gradient(circle, rgba(255,0,0,0.8) 0%, rgba(255,165,0,0.5) 40%, rgba(0,0,255,0) 70%)`,
                  opacity: point.intensity * 0.8,
                }}
              />
            ))}
          </div>
          <div className="absolute bottom-3 right-3 bg-black/60 backdrop-blur-sm px-3 py-1 rounded-lg">
            <span className="text-[10px] text-slate-300 font-semibold uppercase tracking-wider flex items-center gap-1.5">
              <Eye size={12} /> Mappa Attentiva AI
            </span>
          </div>
        </div>
      );

      const ScoreRing = ({ score, size = 128, strokeWidth = 8 }) => {
        const radius = (size / 2) - strokeWidth - 4;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;
        const color = score >= 80 ? 'stroke-emerald-500' : score >= 50 ? 'stroke-yellow-500' : 'stroke-red-500';
        const textColor = score >= 80 ? 'text-emerald-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400';
        
        return (
          <div className="relative" style={{ width: size, height: size }}>
            <svg className="w-full h-full transform -rotate-90">
              <circle cx={size/2} cy={size/2} r={radius} className="stroke-slate-700/50" strokeWidth={strokeWidth} fill="none" />
              <circle cx={size/2} cy={size/2} r={radius} className={`transition-all duration-1000 ease-out ${color}`}
                strokeWidth={strokeWidth} strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" fill="none"
              />
            </svg>
            <div className="absolute inset-0 flex items-center justify-center flex-col">
              <span className={`font-black ${textColor}`} style={{ fontSize: size * 0.25 }}>{score}</span>
              <span className="text-[10px] text-slate-500 font-medium">/ 100</span>
            </div>
          </div>
        );
      };

      const ScoreCard = ({ title, score }) => (
        <div className="glass-panel p-5 rounded-2xl flex flex-col items-center justify-center text-center hover:bg-slate-800/60 transition-all duration-300">
          <ScoreRing score={score} size={100} strokeWidth={6} />
          <h3 className="text-sm font-semibold text-slate-300 mt-3">{title}</h3>
        </div>
      );

      const PrincipleCard = ({ item }) => {
        const statusConfig = {
          applicato: { bg: 'bg-emerald-500/15', text: 'text-emerald-400', border: 'border-emerald-500/25', icon: <CheckCircle2 size={14} /> },
          mancante: { bg: 'bg-slate-700/50', text: 'text-slate-400', border: 'border-slate-600/50', icon: <X size={14} /> },
          parziale: { bg: 'bg-amber-500/15', text: 'text-amber-400', border: 'border-amber-500/25', icon: <AlertTriangle size={14} /> }
        };
        const config = statusConfig[item.status] || statusConfig.parziale;
        
        return (
          <div className="bg-slate-800/30 border border-slate-700/40 rounded-2xl p-5 hover:border-indigo-500/30 hover:bg-slate-800/50 transition-all duration-300">
            <div className="flex justify-between items-start mb-4">
              <h4 className="text-base font-bold text-white leading-tight pr-2">{item.name}</h4>
              <span className={`px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider flex items-center gap-1 shrink-0 ${config.bg} ${config.text} border ${config.border}`}>
                {config.icon} {item.status}
              </span>
            </div>
            <div className="space-y-3">
              <p className="text-slate-400 text-sm leading-relaxed">{item.observation}</p>
              {item.status !== 'applicato' && item.improvement && (
                <div className="pt-3 border-t border-white/5">
                  <p className="text-[10px] text-indigo-400 uppercase font-bold mb-1 tracking-widest">Suggerimento</p>
                  <p className="text-slate-200 text-sm leading-relaxed">{item.improvement}</p>
                </div>
              )}
            </div>
          </div>
        );
      };

      const AnalyzingOverlay = () => (
        <div className="mt-8 w-full max-w-xl mx-auto animate-fade-in-up">
          <div className="glass-panel p-8 rounded-3xl text-center space-y-6">
            <div className="w-16 h-16 mx-auto bg-indigo-600/20 rounded-2xl flex items-center justify-center pulse-glow">
              <Brain className="w-8 h-8 text-indigo-400 animate-pulse" />
            </div>
            <div>
              <h3 className="text-lg font-bold text-white mb-2">Analisi in corso...</h3>
              <p className="text-sm text-slate-400">L'AI sta esaminando la tua landing page</p>
            </div>
            <div className="space-y-3">
              <div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
                <div className="h-full bg-gradient-to-r from-indigo-600 to-cyan-500 rounded-full progress-bar"></div>
              </div>
              <div className="flex justify-between text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                <span>Gerarchia visiva</span>
                <span>Copy & UVP</span>
                <span>CRO Audit</span>
              </div>
            </div>
            <div className="grid grid-cols-3 gap-3 pt-2">
              {['Analisi visiva', 'Audit CRO', 'Strategia'].map((step, i) => (
                <div key={i} className="shimmer bg-slate-800/50 rounded-xl p-3">
                  <div className="h-2 bg-slate-700 rounded mb-2 w-3/4"></div>
                  <div className="h-1.5 bg-slate-700/50 rounded w-1/2"></div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

      // --- REPORT SECTION ---
      const ReportSection = ({ data }) => {
        const { report } = data;
        
        const getCategoryAvg = (cat) => {
          if (!cat?.points?.length) return 0;
          return Math.round(cat.points.reduce((acc, p) => acc + p.score, 0) / cat.points.length);
        };
        
        return (
          <div className="space-y-20">
            {/* EXECUTIVE SUMMARY */}
            <section id="section-executive" className="animate-fade-in-up">
              <div className="flex items-center gap-4 mb-8">
                <div className="bg-indigo-500/20 p-3 rounded-xl border border-indigo-500/30">
                  <Activity className="text-indigo-400 w-7 h-7" />
                </div>
                <div>
                  <h2 className="text-2xl md:text-3xl font-black text-white uppercase tracking-tight">Executive Summary</h2>
                  <p className="text-sm text-slate-500">Panoramica strategica dell'analisi</p>
                </div>
              </div>
              <div className="glass-panel p-6 md:p-8 rounded-3xl border-l-4 border-indigo-500">
                <p className="text-lg md:text-xl text-white font-semibold italic mb-8 leading-relaxed">"{report.executiveSummary.judgment}"</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <div className="space-y-4">
                    <h3 className="text-xs font-black text-red-400 uppercase tracking-widest flex items-center gap-2">
                      <AlertTriangle size={16} /> Top 3 Problemi Bloccanti
                    </h3>
                    <ul className="space-y-3">
                      {report.executiveSummary.topProblems.map((p, i) => (
                        <li key={i} className="text-slate-300 text-sm flex gap-3 items-start leading-relaxed">
                          <span className="w-7 h-7 rounded-lg bg-red-500/15 text-red-400 flex items-center justify-center text-xs font-bold shrink-0 mt-0.5">{i+1}</span>
                          {p}
                        </li>
                      ))}
                    </ul>
                  </div>
                  <div className="space-y-4">
                    <h3 className="text-xs font-black text-emerald-400 uppercase tracking-widest flex items-center gap-2">
                      <Zap size={16} /> Top 3 Azioni Prioritarie
                    </h3>
                    <ul className="space-y-3">
                      {report.executiveSummary.topActions.map((a, i) => (
                        <li key={i} className="text-slate-300 text-sm flex gap-3 items-start leading-relaxed">
                          <span className="w-7 h-7 rounded-lg bg-emerald-500/15 text-emerald-400 flex items-center justify-center text-xs font-bold shrink-0 mt-0.5">{i+1}</span>
                          {a}
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </div>
            </section>

            {/* CATEGORIE 1-40 */}
            {report.categories.map((cat, idx) => (
              <section key={idx} id={`section-cat-${idx}`} className="space-y-6">
                <div className="flex items-center gap-4 border-b border-slate-800 pb-5">
                  <div className="w-11 h-11 rounded-xl bg-slate-800 flex items-center justify-center text-lg font-black text-indigo-400 border border-slate-700">{idx + 1}</div>
                  <div>
                    <h2 className="text-xl md:text-2xl font-black text-white uppercase tracking-tight">{cat.title}</h2>
                    <p className="text-xs text-slate-500">Media categoria: <span className={`font-bold ${getCategoryAvg(cat) >= 80 ? 'text-emerald-400' : getCategoryAvg(cat) >= 50 ? 'text-yellow-400' : 'text-red-400'}`}>{getCategoryAvg(cat)}/100</span></p>
                  </div>
                </div>
                <div className="grid grid-cols-1 gap-5">
                  {cat.points.map((point) => (
                    <div key={point.id} className="glass-panel p-6 md:p-7 rounded-2xl hover:bg-slate-800/40 transition-all border border-white/5">
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-5">
                        <div className="flex gap-3 items-center">
                          <span className="text-slate-600 font-black text-base">#{point.id}</span>
                          <h3 className="text-lg font-bold text-white">{point.name}</h3>
                        </div>
                        <div className="flex items-center gap-3 shrink-0">
                          <div className={`text-xl font-black ${point.score >= 80 ? 'text-emerald-500' : point.score >= 50 ? 'text-yellow-500' : 'text-red-500'}`}>{point.score}<span className="text-sm text-slate-600">/100</span></div>
                          <ScoreRing score={point.score} size={48} strokeWidth={4} />
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div className="bg-red-500/5 p-5 rounded-xl border border-red-500/10">
                          <h4 className="text-[10px] font-black text-red-400 uppercase mb-2 tracking-widest flex items-center gap-1.5">
                            <AlertCircle size={12} /> Problemi
                          </h4>
                          <p className="text-slate-300 text-sm leading-relaxed">{point.problems}</p>
                        </div>
                        <div className="bg-emerald-500/5 p-5 rounded-xl border border-emerald-500/10">
                          <h4 className="text-[10px] font-black text-emerald-400 uppercase mb-2 tracking-widest flex items-center gap-1.5">
                            <ArrowRight size={12} /> Azioni
                          </h4>
                          <p className="text-white text-sm leading-relaxed font-medium">{point.actions}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </section>
            ))}

            {/* BEHAVIORAL ANALYSIS */}
            <section id="section-behavioral" className="space-y-6">
              <div className="flex items-center gap-4 border-b border-slate-800 pb-5">
                <div className="bg-purple-500/20 p-3 rounded-xl border border-purple-500/30">
                  <Brain className="w-7 h-7 text-purple-400" />
                </div>
                <div>
                  <h2 className="text-xl md:text-2xl font-black text-white uppercase tracking-tight">Analisi Comportamentale</h2>
                  <p className="text-sm text-slate-400">Bias cognitivi e principi psicologici</p>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {report.behavioral?.map((item, i) => <PrincipleCard key={i} item={item} />)}
              </div>
            </section>

            {/* NLP ANALYSIS */}
            <section id="section-nlp" className="space-y-6">
              <div className="flex items-center gap-4 border-b border-slate-800 pb-5">
                <div className="bg-pink-500/20 p-3 rounded-xl border border-pink-500/30">
                  <MessageSquareQuote className="w-7 h-7 text-pink-400" />
                </div>
                <div>
                  <h2 className="text-xl md:text-2xl font-black text-white uppercase tracking-tight">Analisi NLP & Copy</h2>
                  <p className="text-sm text-slate-400">Neuro-linguistica e tono di voce</p>
                </div>
              </div>
              <div className="glass-panel p-6 md:p-8 rounded-3xl space-y-8">
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 pb-6 border-b border-white/5">
                  <div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Tono di Voce</div>
                    <div className="text-xl font-bold text-white">{report.nlp.tone}</div>
                  </div>
                  <div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Livello Lettura</div>
                    <div className="text-xl font-bold text-white">{report.nlp.readingLevel}</div>
                  </div>
                  <div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-2">Trigger Emotivi</div>
                    <div className="flex flex-wrap gap-1.5">
                      {report.nlp.emotionalTriggers?.map((t, i) => (
                        <span key={i} className="px-2 py-1 rounded-lg bg-pink-500/10 border border-pink-500/20 text-[10px] text-pink-300 font-bold">{t}</span>
                      ))}
                    </div>
                  </div>
                </div>
                <div>
                  <h3 className="text-base font-bold text-white mb-5 uppercase tracking-widest">Principi NLP</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {report.nlp.principles?.map((item, i) => <PrincipleCard key={i} item={item} />)}
                  </div>
                </div>
              </div>
            </section>

            {/* OPTIMIZATION */}
            <section id="section-optimization" className="space-y-10">
              <div className="flex items-center gap-4 border-b border-slate-800 pb-5">
                <div className="bg-cyan-500/20 p-3 rounded-xl border border-cyan-500/30">
                  <Target className="w-7 h-7 text-cyan-400" />
                </div>
                <div>
                  <h2 className="text-xl md:text-2xl font-black text-white uppercase tracking-tight">Ottimizzazione e Strategia</h2>
                  <p className="text-sm text-slate-400">Punti 41-44: Piano d'azione operativo</p>
                </div>
              </div>

              {/* Impact Scores */}
              <div className="space-y-5">
                <h3 className="text-lg font-black text-white uppercase flex items-center gap-2">
                  <TrendingUp className="text-indigo-400" size={20} /> 41. Stima Impatto
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  {report.optimization.impactScores.map((item, i) => (
                    <div key={i} className="glass-panel p-5 rounded-2xl border-t-4 border-indigo-500 hover:bg-slate-800/50 transition-all">
                      <div className="flex justify-between items-start mb-3">
                        <h4 className="font-bold text-white text-sm">{item.area}</h4>
                        <span className={`px-2 py-0.5 rounded text-[9px] font-black uppercase ${
                          item.impact === 'Alto' ? 'bg-red-500/15 text-red-400' : 'bg-yellow-500/15 text-yellow-400'
                        }`}>Impatto {item.impact}</span>
                      </div>
                      <div className="text-2xl font-black text-indigo-400 mb-1">{item.boost}</div>
                      <div className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Priorità #{item.priority}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Operational Priorities */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="glass-panel p-6 rounded-2xl border-2 border-indigo-500/20">
                  <h3 className="text-base font-black text-white mb-5 uppercase flex items-center gap-2">
                    <List size={18} className="text-indigo-400" /> 42. 5 Azioni Singole
                  </h3>
                  <ul className="space-y-3">
                    {report.optimization.operationalPriorities.singles.map((s, i) => (
                      <li key={i} className="flex gap-3 items-start text-sm text-slate-200">
                        <span className="w-7 h-7 rounded-lg bg-indigo-600 flex items-center justify-center font-bold text-white text-xs shrink-0">{i+1}</span>
                        {s}
                      </li>
                    ))}
                  </ul>
                </div>
                <div className="glass-panel p-6 rounded-2xl border-2 border-emerald-500/20">
                  <h3 className="text-base font-black text-white mb-5 uppercase flex items-center gap-2">
                    <Layers size={18} className="text-emerald-400" /> 3 Combo da Testare
                  </h3>
                  <ul className="space-y-3">
                    {report.optimization.operationalPriorities.combos.map((c, i) => (
                      <li key={i} className="flex gap-3 items-start text-sm text-slate-200">
                        <span className="w-7 h-7 rounded-lg bg-emerald-600 flex items-center justify-center font-bold text-white text-xs shrink-0">{String.fromCharCode(65+i)}</span>
                        {c}
                      </li>
                    ))}
                  </ul>
                </div>
              </div>

              {/* A/B Test Plan */}
              <div className="glass-panel p-6 md:p-8 rounded-3xl">
                <h3 className="text-base font-black text-white mb-6 uppercase flex items-center gap-2">
                  <Repeat className="text-purple-400" size={18} /> 43. Piano Test A/B
                </h3>
                <div className="space-y-4">
                  {report.optimization.abTestPlan.map((test, i) => (
                    <div key={i} className="p-5 rounded-xl bg-slate-900/50 border border-slate-700/50 grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <div className="text-[9px] font-bold text-slate-500 uppercase mb-1">Test</div>
                        <div className="text-white font-bold text-sm">{test.test}</div>
                      </div>
                      <div>
                        <div className="text-[9px] font-bold text-slate-500 uppercase mb-1">Variante</div>
                        <div className="text-slate-300 text-sm">{test.change}</div>
                      </div>
                      <div>
                        <div className="text-[9px] font-bold text-slate-500 uppercase mb-1">Perché</div>
                        <div className="text-slate-400 text-xs leading-relaxed">{test.reason}</div>
                      </div>
                      <div>
                        <div className="text-[9px] font-bold text-purple-400 uppercase mb-1">Metrica</div>
                        <div className="text-purple-400 font-bold text-sm">{test.metric}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Strategic Guidelines */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div className="glass-panel p-6 rounded-2xl border-l-4 border-pink-500">
                  <h3 className="text-[10px] font-black text-pink-400 uppercase mb-3 tracking-widest">44a. Tono di Voce</h3>
                  <p className="text-slate-300 text-sm leading-relaxed">{report.optimization.strategicGuidelines.toneOfVoice}</p>
                </div>
                <div className="glass-panel p-6 rounded-2xl border-l-4 border-yellow-500">
                  <h3 className="text-[10px] font-black text-yellow-500 uppercase mb-3 tracking-widest">44b. Leve Dominanti</h3>
                  <div className="flex flex-wrap gap-2 mt-2">
                    {report.optimization.strategicGuidelines.dominantLevers.map((l, i) => (
                      <span key={i} className="bg-yellow-500/10 text-yellow-400 px-3 py-1 rounded-lg text-[10px] font-bold uppercase border border-yellow-500/20">{l}</span>
                    ))}
                  </div>
                </div>
                <div className="glass-panel p-6 rounded-2xl border-l-4 border-emerald-500">
                  <h3 className="text-[10px] font-black text-emerald-400 uppercase mb-3 tracking-widest">44c. Ordine Argomenti</h3>
                  <p className="text-slate-300 text-sm leading-relaxed">{report.optimization.strategicGuidelines.argumentOrder}</p>
                </div>
              </div>
            </section>

            {/* FINAL SUMMARY */}
            <section id="section-final" className="glass-panel p-8 md:p-10 rounded-3xl bg-slate-950/50 border-2 border-indigo-500/20 text-center">
              <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-indigo-500/30">
                <CheckCircle2 size={32} className="text-white" />
              </div>
              <h2 className="text-3xl md:text-4xl font-black text-white uppercase tracking-tighter mb-2">45. Riepilogo Finale</h2>
              <p className="text-sm text-slate-500 mb-8">Punteggio globale della landing page</p>
              
              <div className="flex justify-center mb-8">
                <ScoreRing score={report.finalSummary.overallScore} size={180} strokeWidth={10} />
              </div>
              
              <p className="text-lg text-slate-300 italic max-w-3xl mx-auto leading-relaxed mb-10">
                "{report.finalSummary.conclusion}"
              </p>
              
              <div className="overflow-hidden rounded-2xl border border-slate-800">
                <table className="w-full text-left border-collapse">
                  <thead>
                    <tr className="bg-slate-900/80">
                      <th className="p-4 text-[10px] font-black text-slate-500 uppercase tracking-wider">Categoria</th>
                      <th className="p-4 text-[10px] font-black text-slate-500 uppercase tracking-wider text-center">Score Medio</th>
                    </tr>
                  </thead>
                  <tbody>
                    {report.categories.map((cat, i) => {
                      const avg = Math.round(cat.points.reduce((acc, p) => acc + p.score, 0) / cat.points.length);
                      return (
                        <tr key={i} className="border-t border-slate-800/50 hover:bg-slate-800/30 transition-colors">
                          <td className="p-4 text-sm font-semibold text-white">{cat.title}</td>
                          <td className="p-4 text-center">
                            <span className={`px-3 py-1 rounded-lg text-xs font-black ${
                              avg >= 80 ? 'bg-emerald-500/15 text-emerald-400' : 
                              avg >= 50 ? 'bg-yellow-500/15 text-yellow-400' : 
                              'bg-red-500/15 text-red-400'
                            }`}>{avg}/100</span>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </section>
          </div>
        );
      };

      // --- MAIN APP ---
      const App = () => {
        const [status, setStatus] = useState(AnalysisStatus.IDLE);
        const [imagePreview, setImagePreview] = useState(null);
        const [result, setResult] = useState(null);
        const [errorMsg, setErrorMsg] = useState("");
        const [isDownloading, setIsDownloading] = useState(false);
        const [apiKey, setApiKey] = useState(() => {
          try { return window.localStorage.getItem('GEMINI_API_KEY') || ""; } 
          catch { return ""; }
        });
        const [showSettings, setShowSettings] = useState(false);
        const [useMock, setUseMock] = useState(true);
        const [isDragOver, setIsDragOver] = useState(false);
        const [toast, setToast] = useState({ message: '', type: 'info', visible: false });
        const reportRef = useRef(null);
        const resultRef = useRef(null);
        const fileInputRef = useRef(null);

        const showToast = useCallback((message, type = 'info') => {
          setToast({ message, type, visible: true });
          setTimeout(() => setToast(prev => ({ ...prev, visible: false })), 3500);
        }, []);

        const saveApiKey = useCallback((val) => {
          setApiKey(val);
          try { window.localStorage.setItem('GEMINI_API_KEY', val); } catch {}
        }, []);

        const processFile = useCallback((file) => {
          if (!file) return;
          if (!file.type.startsWith('image/')) {
            showToast('Carica un file immagine (PNG, JPG, WebP)', 'error');
            return;
          }
          if (file.size > 20 * 1024 * 1024) {
            showToast('File troppo grande. Max 20MB.', 'error');
            return;
          }
          const reader = new FileReader();
          reader.onloadend = () => {
            setImagePreview(reader.result);
            setResult(null);
            setErrorMsg("");
            setStatus(AnalysisStatus.IDLE);
          };
          reader.readAsDataURL(file);
        }, [showToast]);

        const handleFileChange = useCallback((event) => {
          processFile(event.target.files?.[0]);
          // Reset input so same file can be selected again
          if (event.target) event.target.value = '';
        }, [processFile]);

        // Drag & Drop
        const handleDragOver = useCallback((e) => { e.preventDefault(); e.stopPropagation(); setIsDragOver(true); }, []);
        const handleDragLeave = useCallback((e) => { e.preventDefault(); e.stopPropagation(); setIsDragOver(false); }, []);
        const handleDrop = useCallback((e) => {
          e.preventDefault(); e.stopPropagation(); setIsDragOver(false);
          processFile(e.dataTransfer.files?.[0]);
        }, [processFile]);

        const handleAnalyze = async () => {
          if (!imagePreview) return;
          if (!useMock && !apiKey) {
            showToast('Configura la tua API Key o usa la modalità Mock.', 'error');
            setShowSettings(true);
            return;
          }
          
          const base64Data = imagePreview.split(',')[1];
          setStatus(AnalysisStatus.ANALYZING);
          setErrorMsg("");
          
          try {
            let data;
            if (useMock) {
              data = await getMockAnalysis();
            } else {
              data = await analyzeWithGemini(base64Data, apiKey);
            }
            
            // Validate response structure
            if (!data?.report?.executiveSummary || !data?.report?.categories) {
              throw new Error("La risposta dell'AI non ha il formato atteso. Riprova.");
            }
            
            setResult(data);
            setStatus(AnalysisStatus.COMPLETE);
            showToast('Analisi completata con successo!', 'success');
            
            // Scroll to results
            setTimeout(() => {
              resultRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
          } catch (err) {
            console.error("Analysis error:", err);
            setErrorMsg(err.message || "Errore imprevisto durante l'analisi.");
            setStatus(AnalysisStatus.ERROR);
            showToast(err.message || 'Errore durante l\'analisi', 'error');
          }
        };

        const handleReset = useCallback(() => {
          setStatus(AnalysisStatus.IDLE);
          setImagePreview(null);
          setResult(null);
          setErrorMsg("");
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, []);

        const downloadReport = async (format) => {
          if (!reportRef.current) return;
          setIsDownloading(true);
          showToast(`Preparazione download ${format.toUpperCase()}...`);
          
          try {
            if (format === 'docx') {
              const sourceHTML = `<html><head><meta charset='utf-8'><style>body{font-family:Arial,sans-serif;color:#1e293b;line-height:1.6}h2{color:#4f46e5;border-bottom:2px solid #e2e8f0;padding-bottom:8px}h3{color:#334155}.score{font-weight:bold;font-size:1.2em}.problems{color:#dc2626;background:#fef2f2;padding:12px;border-radius:8px;margin:8px 0}.actions{color:#059669;background:#f0fdf4;padding:12px;border-radius:8px;margin:8px 0}</style></head><body><h1 style="color:#4f46e5">CreativeScore AI - Report Analisi CRO</h1>${reportRef.current.innerHTML}</body></html>`;
              const blob = new Blob(['\ufeff', sourceHTML], { type: 'application/msword' });
              const link = document.createElement("a");
              link.href = URL.createObjectURL(blob);
              link.download = `CreativeScore-Report-${new Date().toISOString().slice(0,10)}.doc`;
              link.click();
              URL.revokeObjectURL(link.href);
              showToast('Download DOCX completato!', 'success');
            } else {
              // Dynamic import for html2canvas/jspdf
              const html2canvasModule = await import('https://esm.sh/html2canvas@1.4.1');
              const html2canvas = html2canvasModule.default;
              
              const canvas = await html2canvas(reportRef.current, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#0f172a',
                logging: false,
                allowTaint: true,
                windowWidth: reportRef.current.scrollWidth,
                windowHeight: reportRef.current.scrollHeight
              });
              
              if (format === 'pdf') {
                const jspdfModule = await import('https://esm.sh/jspdf@2.5.1');
                const { jsPDF } = jspdfModule;
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft > 0) {
                  position = heightLeft - imgHeight;
                  pdf.addPage();
                  pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                  heightLeft -= pageHeight;
                }
                
                pdf.save(`CreativeScore-Report-${new Date().toISOString().slice(0,10)}.pdf`);
                showToast('Download PDF completato!', 'success');
              } else {
                const link = document.createElement('a');
                link.download = `CreativeScore-Report-${new Date().toISOString().slice(0,10)}.${format}`;
                link.href = canvas.toDataURL(`image/${format}`, 0.95);
                link.click();
                showToast(`Download ${format.toUpperCase()} completato!`, 'success');
              }
            }
          } catch (err) {
            console.error("Download error:", err);
            showToast('Errore durante il download. Riprova.', 'error');
          } finally {
            setIsDownloading(false);
          }
        };

        const safeGetCatAvg = (index) => {
          const cat = result?.report?.categories?.[index];
          if (!cat?.points?.length) return 0;
          return Math.round(cat.points.reduce((acc, p) => acc + p.score, 0) / cat.points.length);
        };

        return (
          <div className="min-h-screen pb-20">
            <Toast {...toast} />
            <ScrollToTop />

            {/* HEADER */}
            <header className="border-b border-white/10 bg-[#0f172a]/90 backdrop-blur-lg sticky top-0 z-50">
              <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div className="flex items-center gap-3 cursor-pointer" onClick={handleReset}>
                  <div className="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-500/20">
                    <ScanEye className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <h1 className="text-lg font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent leading-tight">CreativeScore AI</h1>
                    <p className="text-[9px] text-slate-500 font-medium uppercase tracking-widest -mt-0.5">CRO & Behavioral Analyzer</p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {result && (
                    <button onClick={handleReset} className="flex items-center gap-1.5 text-slate-400 hover:text-white transition-colors px-3 py-2 rounded-lg hover:bg-slate-800 text-sm font-medium" aria-label="Nuova analisi">
                      <RotateCcw size={16} /> <span className="hidden sm:inline">Nuova</span>
                    </button>
                  )}
                  <button onClick={() => setShowSettings(!showSettings)} className="text-slate-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-slate-800" aria-label="Impostazioni">
                    <Settings className={`w-5 h-5 transition-transform ${showSettings ? 'rotate-90 text-indigo-400' : ''}`} />
                  </button>
                </div>
              </div>
              
              {/* Settings Panel */}
              {showSettings && (
                <div className="bg-slate-900/95 backdrop-blur-lg border-b border-white/10 p-4 animate-fade-in-up">
                  <div className="max-w-7xl mx-auto flex flex-col md:flex-row gap-4 items-stretch md:items-end">
                    <div className="flex-grow">
                      <label className="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block tracking-wider">Gemini API Key</label>
                      <input
                        type="password"
                        value={apiKey}
                        onChange={(e) => saveApiKey(e.target.value)}
                        placeholder="Incolla qui la tua Gemini API Key..."
                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2.5 text-sm text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all"
                      />
                      <p className="text-[10px] text-slate-600 mt-1">Necessaria solo in modalità "Real AI". Ottienila da <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener" className="text-indigo-400 hover:underline">Google AI Studio</a></p>
                    </div>
                    <div className="flex items-center gap-1 bg-slate-800 p-1.5 rounded-xl border border-slate-700 shrink-0">
                      <button onClick={() => setUseMock(true)} className={`px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${useMock ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>
                        Demo
                      </button>
                      <button onClick={() => setUseMock(false)} className={`px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${!useMock ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>
                        Real AI
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </header>

            <main className="max-w-7xl mx-auto px-4 mt-8 md:mt-12">
              {/* HERO + UPLOAD */}
              {!result && (
                <div className="text-center mb-12 upload-section">
                  <div className="mb-8">
                    <h2 className="text-3xl md:text-5xl font-black text-white mb-4 leading-tight">
                      Ottimizza le Conversioni con<br />
                      <span className="bg-gradient-to-r from-indigo-400 via-purple-400 to-cyan-400 bg-clip-text text-transparent">Analisi AI Predittiva</span>
                    </h2>
                    <p className="text-slate-400 text-lg max-w-2xl mx-auto">
                      Carica lo screenshot della tua landing page e ricevi un audit completo di 45 punti con analisi comportamentale e strategica.
                    </p>
                  </div>
                  
                  <div className="w-full max-w-xl mx-auto">
                    <label
                      className={`flex flex-col items-center justify-center w-full rounded-2xl cursor-pointer transition-all duration-300 ${
                        isDragOver ? 'drop-zone-active border-2 border-dashed' :
                        imagePreview ? 'border-2 border-indigo-500/50 bg-indigo-900/10 p-4' : 
                        'h-64 border-2 border-dashed border-slate-700 hover:border-indigo-400 hover:bg-slate-800/50'
                      }`}
                      onDragOver={handleDragOver}
                      onDragLeave={handleDragLeave}
                      onDrop={handleDrop}
                    >
                      {imagePreview ? (
                        <div className="relative group">
                          <img src={imagePreview} className="max-h-[300px] rounded-xl shadow-2xl" alt="Preview" />
                          <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl flex items-center justify-center">
                            <span className="text-white font-semibold text-sm flex items-center gap-2"><Upload size={18} /> Cambia immagine</span>
                          </div>
                        </div>
                      ) : (
                        <div className="text-slate-400 flex flex-col items-center py-8">
                          <div className="w-16 h-16 rounded-2xl bg-slate-800 flex items-center justify-center mb-4 border border-slate-700">
                            <Upload className="w-8 h-8 text-indigo-400" />
                          </div>
                          <p className="font-semibold text-white mb-1">Trascina qui o clicca per caricare</p>
                          <p className="text-sm text-slate-500">PNG, JPG, WebP — Max 20MB</p>
                        </div>
                      )}
                      <input ref={fileInputRef} type="file" className="hidden" onChange={handleFileChange} accept="image/*" />
                    </label>
                    
                    {imagePreview && status === AnalysisStatus.IDLE && (
                      <button onClick={handleAnalyze} className="mt-6 w-full py-4 bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2 shadow-xl shadow-indigo-500/20 hover:shadow-indigo-500/40">
                        <Sparkles className="w-5 h-5" />
                        Analizza Landing Page
                        {!useMock && <span className="text-[9px] bg-white/20 px-2 py-0.5 rounded-full ml-1 uppercase">AI</span>}
                      </button>
                    )}
                    
                    {status === AnalysisStatus.ANALYZING && <AnalyzingOverlay />}
                    
                    {status === AnalysisStatus.ERROR && (
                      <div className="mt-6 w-full p-5 bg-red-500/10 border border-red-500/20 text-red-300 rounded-xl flex items-start gap-3 text-left">
                        <AlertCircle className="w-5 h-5 shrink-0 mt-0.5 text-red-400" />
                        <div>
                          <p className="font-bold text-red-400 text-sm mb-1">Errore nell'analisi</p>
                          <p className="text-sm">{errorMsg}</p>
                          <button onClick={handleAnalyze} className="mt-3 text-sm text-red-400 hover:text-red-300 underline flex items-center gap-1">
                            <RotateCcw size={14} /> Riprova
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  {/* Feature highlights */}
                  {!imagePreview && (
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-12 max-w-3xl mx-auto">
                      {[
                        { icon: <ScanEye size={20} />, title: "45 Punti di Audit", desc: "Analisi completa CRO e UX" },
                        { icon: <Brain size={20} />, title: "20 Bias Cognitivi", desc: "Analisi comportamentale profonda" },
                        { icon: <Target size={20} />, title: "Piano Strategico", desc: "A/B test e azioni prioritarie" }
                      ].map((f, i) => (
                        <div key={i} className="glass-panel p-5 rounded-2xl text-center">
                          <div className="text-indigo-400 flex justify-center mb-3">{f.icon}</div>
                          <h3 className="text-sm font-bold text-white mb-1">{f.title}</h3>
                          <p className="text-xs text-slate-500">{f.desc}</p>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* RESULTS */}
              {status === AnalysisStatus.COMPLETE && result && (
                <div ref={resultRef} className="animate-fade-in-up space-y-12">
                  {/* Results Header */}
                  <div className="border-t border-slate-800 pt-8 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div>
                      <h2 className="text-2xl md:text-3xl font-black text-white uppercase tracking-tighter">Report Analisi Completa</h2>
                      <p className="text-sm text-slate-500 mt-1">
                        {useMock ? '⚡ Modalità Demo' : '🤖 Generato con Gemini AI'} — {new Date().toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}
                      </p>
                    </div>
                    <div className="flex flex-wrap gap-2 download-buttons">
                      {[
                        { fmt: 'pdf', icon: <FileText size={14} />, label: 'PDF' },
                        { fmt: 'png', icon: <ImageIcon size={14} />, label: 'PNG' },
                        { fmt: 'jpeg', icon: <ImageIcon size={14} />, label: 'JPEG' },
                        { fmt: 'docx', icon: <FileDown size={14} />, label: 'DOC' }
                      ].map(({ fmt, icon, label }) => (
                        <button key={fmt} onClick={() => downloadReport(fmt)} disabled={isDownloading}
                          className="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-xl border border-slate-700 text-xs font-bold uppercase disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-1.5 transition-all hover:border-slate-600">
                          {isDownloading ? <Loader2 size={14} className="animate-spin" /> : icon} {label}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Main Report */}
                  <div ref={reportRef} className="space-y-20 p-4 md:p-8 bg-slate-900/50 rounded-3xl border border-white/5">
                    {/* Title */}
                    <div className="text-center pt-4">
                      <h2 className="text-3xl md:text-4xl font-black text-white uppercase tracking-tighter">Audit CRO & Persuasione</h2>
                      <div className="w-24 h-1.5 bg-gradient-to-r from-indigo-500 to-cyan-500 mx-auto mt-5 rounded-full"></div>
                    </div>

                    {/* Overview Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                      <div className="lg:col-span-7 space-y-4">
                        <h3 className="text-xl font-bold text-slate-200 flex items-center gap-2 uppercase tracking-tighter">
                          <Eye className="text-indigo-400" size={22} /> Mappa Attentiva Predittiva
                        </h3>
                        <HeatmapOverlay imageSrc={imagePreview} points={result.heatmap} />
                      </div>
                      <div className="lg:col-span-5 grid grid-cols-2 gap-3 content-start">
                        <div className="col-span-2">
                          <ScoreCard title="Score Globale" score={result.report.finalSummary.overallScore} />
                        </div>
                        {result.report.categories.slice(0, 4).map((cat, i) => (
                          <ScoreCard key={i} title={cat.title.split(' ').slice(0, 2).join(' ')} score={safeGetCatAvg(i)} />
                        ))}
                      </div>
                    </div>

                    {/* Full Report */}
                    <ReportSection data={result} />
                  </div>
                </div>
              )}
            </main>

            {/* Footer */}
            <footer className="mt-20 border-t border-slate-800/50 py-8 text-center">
              <p className="text-[10px] text-slate-600 uppercase tracking-widest">
                CreativeScore AI — Analisi CRO Automatizzata con Intelligenza Artificiale
              </p>
            </footer>
          </div>
        );
      };

      // --- RENDER ---
      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
